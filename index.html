<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RegiMaster Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }
        /* Hide scrollbar for badge list */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Print settings */
        @media print {
            @page { size: landscape; margin: 3mm; }
            body { visibility: hidden; background: white !important; }
            button, nav, header, .no-print { display: none !important; }
            body > *:not(#root) { display: none !important; }
            .shift-table-container { 
                visibility: visible !important; 
                position: fixed !important; 
                top: 0 !important; 
                left: 0 !important; 
                width: 100vw !important; 
                min-height: 100vh !important; 
                background: white !important; 
                z-index: 2147483647 !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                display: block !important; 
                overflow: visible !important; 
                zoom: var(--print-scale, 1); 
            }
            .shift-table-container * { visibility: visible !important; }
            .print-table-row { display: table-row-group !important; }
            .screen-table-row { display: none !important; }
            .print-area { width: 100%; border-collapse: collapse; font-size: 9px; table-layout: fixed; }
            .print-area th, .print-area td { border: 1px solid #444 !important; text-align: center; height: auto !important; vertical-align: middle; padding: 1px !important; white-space: nowrap; position: static !important; }
            .print-area th { background-color: #dbeafe !important; color: #1e3a8a !important; font-weight: 800 !important; height: 20px !important; font-size: 10px !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print-header { font-size: 16px; font-weight: bold; margin-bottom: 8px; text-align: center; padding-top: 5px; }
            thead { display: table-header-group; } tbody { display: table-row-group; } tr { break-inside: avoid; page-break-inside: avoid; }
        }
    </style>
    
    <!-- Import Map for React & Lucide -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0"
      }
    }
    </script>

    <!-- Babel for in-browser JSX/TS transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Printer, RefreshCw, Settings, Clock, AlertCircle, ArrowLeftRight, 
            UserCheck, UserX, ChevronDown, ChevronUp, History, XCircle, Ban, 
            Users, Monitor, CalendarRange, Save, Database, Plus, Trash2, 
            Edit2, GripVertical, Check, Badge, FileText, Upload, FileJson, Download
        } from 'lucide-react';

        // ==========================================
        // Constants & Types
        // ==========================================
        const DEFAULT_OPEN_TIME = "09:00";
        const DEFAULT_CLOSE_TIME = "21:00";
        const TIME_SLOT_MINUTES = 60;
        const PRIORITY_MAX = 100;
        const PRIORITY_MIN = 0;
        const LOCAL_STORAGE_KEY = 'regi_master_pro_v2';

        const DAYS_OF_WEEK = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 'Holiday'];
        const DAY_LABELS = { Monday: '月', Tuesday: '火', Wednesday: '水', Thursday: '木', Friday: '金', Saturday: '土', Sunday: '日', Holiday: '祝' };

        // ==========================================
        // Logic Services
        // ==========================================
        const parseTime = (timeStr) => {
            if (!timeStr) return -1;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };
        const formatTime = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };
        const generateTimeSlots = (startStr, endStr) => {
            const slots = [];
            let current = parseTime(startStr);
            const end = parseTime(endStr);
            while (current < end) {
                slots.push(formatTime(current));
                current += TIME_SLOT_MINUTES;
            }
            return slots;
        };
        const getDayOfWeek = (dateStr) => {
            const date = new Date(dateStr);
            return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
        };
        const getHolidayName = (date) => {
            const y = date.getFullYear(); const m = date.getMonth() + 1; const d = date.getDate(); const w = date.getDay(); 
            if (m===1 && d===1) return '元日'; if (m===2 && d===11) return '建国記念の日'; if (m===2 && d===23) return '天皇誕生日';
            if (m===4 && d===29) return '昭和の日'; if (m===5 && d===3) return '憲法記念日'; if (m===5 && d===4) return 'みどりの日';
            if (m===5 && d===5) return 'こどもの日'; if (m===11 && d===3) return '文化の日'; if (m===11 && d===23) return '勤労感謝の日';
            if (m===1 && w===1 && Math.ceil(d/7)===2) return '成人の日'; if (m===7 && w===1 && Math.ceil(d/7)===3) return '海の日';
            if (m===9 && w===1 && Math.ceil(d/7)===3) return '敬老の日'; if (m===10 && w===1 && Math.ceil(d/7)===2) return 'スポーツの日';
            const vernal = Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
            if (m===3 && d===vernal) return '春分の日';
            const autumnal = Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
            if (m===9 && d===autumnal) return '秋分の日';
            if (m===8 && d===11) return '山の日';
            return null;
        };
        const isHoliday = (dateStr) => {
            const date = new Date(dateStr);
            if (getHolidayName(date)) return true;
            const yesterday = new Date(date); yesterday.setDate(date.getDate() - 1);
            if (yesterday.getDay() === 0 && getHolidayName(yesterday)) return true;
            return false;
        };

        const generateShift = (date, allStaff, registers, settings) => {
            const dayOfWeekName = getDayOfWeek(date);
            const isTodayHoliday = isHoliday(date);
            const timeSlots = generateTimeSlots(settings.openTime, settings.closeTime);
            const cells = {};
            const activeRegisters = registers.filter(r => r.isActive).sort((a, b) => a.order - b.order);
            const availableStaffForDay = allStaff.filter(s => {
                if (isTodayHoliday && s.daysOff.includes('Holiday')) return false;
                if (s.daysOff.includes(dayOfWeekName)) return false;
                return true;
            });

            timeSlots.forEach((slotTime, timeIndex) => {
                const slotMinutes = parseTime(slotTime);
                const staffAvailableAtSlot = availableStaffForDay.filter(staff => {
                    let config = staff.baseShift;
                    if (isTodayHoliday && staff.irregularShifts['Holiday']) config = staff.irregularShifts['Holiday'];
                    else if (staff.irregularShifts[dayOfWeekName]) config = staff.irregularShifts[dayOfWeekName];
                    
                    const startMin = parseTime(config.start);
                    const endMin = parseTime(config.end);
                    if (slotMinutes < startMin || slotMinutes >= endMin) return false;
                    if (config.breakStart && config.breakEnd) {
                        const breakStartMin = parseTime(config.breakStart);
                        const breakEndMin = parseTime(config.breakEnd);
                        if (slotMinutes >= breakStartMin && slotMinutes < breakEndMin) return false;
                    }
                    if (config.exclusionStart && config.exclusionEnd) {
                        const exStartMin = parseTime(config.exclusionStart);
                        const exEndMin = parseTime(config.exclusionEnd);
                        if (slotMinutes >= exStartMin && slotMinutes < exEndMin) return false;
                    }
                    return true;
                });

                let availablePool = [...staffAvailableAtSlot];
                activeRegisters.forEach((reg) => {
                    let currentPool = [...availablePool];
                    if (reg.isBadgeRole) currentPool = currentPool.filter(s => s.badges && s.badges.includes(reg.name));
                    
                    if (currentPool.length === 0) {
                        cells[`${slotTime}-${reg.id}`] = { registerId: reg.id, staffId: null, isManualOverride: false };
                        return;
                    }
                    const maxPriority = Math.max(...currentPool.map(s => s.priority));
                    const candidates = currentPool.filter(s => s.priority === maxPriority);
                    let selectedStaff = null;
                    if (candidates.length === 1) selectedStaff = candidates[0];
                    else {
                        if (timeIndex > 0) {
                            const prevTime = timeSlots[timeIndex - 1];
                            const prevCell = cells[`${prevTime}-${reg.id}`];
                            if (prevCell?.staffId) {
                                const incumbent = candidates.find(s => s.id === prevCell.staffId);
                                if (incumbent) selectedStaff = incumbent;
                            }
                        }
                        if (!selectedStaff) selectedStaff = candidates[Math.floor(Math.random() * candidates.length)];
                    }
                    cells[`${slotTime}-${reg.id}`] = { registerId: reg.id, staffId: selectedStaff.id, isManualOverride: false };
                    availablePool = availablePool.filter(s => s.id !== selectedStaff.id);
                });
            });
            return { id: crypto.randomUUID(), date, cells, createdAt: Date.now(), attendanceOverrides: {} };
        };

        // ==========================================
        // Components
        // ==========================================
        const StaffView = ({ staffList, setStaffList, availableBadges = [] }) => {
            const [isEditing, setIsEditing] = useState(null);
            const [editForm, setEditForm] = useState(null);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const fileInputRef = useRef(null);
            const [frozenOrder, setFrozenOrder] = useState(null);

            const displayList = useMemo(() => {
                if (frozenOrder) return frozenOrder.map(id => staffList.find(s => s.id === id)).filter(s => !!s);
                return [...staffList].sort((a, b) => b.priority - a.priority);
            }, [staffList, frozenOrder]);

            const handleDragStart = () => { setFrozenOrder([...staffList].sort((a, b) => b.priority - a.priority).map(s => s.id)); };
            const handleDragEnd = () => { setFrozenOrder(null); };
            
            const handleAdd = () => {
                const newStaff = { id: crypto.randomUUID(), name: '新規スタッフ', type: 'SPECIALIST', priority: 50, daysOff: [], baseShift: { start: '09:00', end: '18:00' }, irregularShifts: {}, badges: [] };
                setStaffList([...staffList, newStaff]);
                startEdit(newStaff);
            };
            const startEdit = (staff) => { setIsEditing(staff.id); setEditForm(JSON.parse(JSON.stringify({ ...staff, badges: staff.badges || [] }))); setDeleteConfirmId(null); };
            const saveEdit = () => { if (!editForm) return; setStaffList(staffList.map(s => s.id === editForm.id ? editForm : s)); setIsEditing(null); setEditForm(null); };
            const deleteStaff = (id) => {
                if (deleteConfirmId === id) { if (isEditing === id) { setIsEditing(null); setEditForm(null); } setStaffList(staffList.filter(s => s.id !== id)); setDeleteConfirmId(null); } 
                else { setDeleteConfirmId(id); setTimeout(() => setDeleteConfirmId(prev => prev === id ? null : prev), 3000); }
            };
            const handlePriorityChange = (id, val) => { setStaffList(staffList.map(s => s.id === id ? { ...s, priority: val } : s)); };
            const toggleDayOff = (day) => { const c = editForm.daysOff; setEditForm({ ...editForm, daysOff: c.includes(day) ? c.filter(d => d !== day) : [...c, day] }); };
            const toggleBadge = (badge) => { const b = editForm.badges; setEditForm({ ...editForm, badges: b.includes(badge) ? b.filter(x => x !== badge) : [...b, badge] }); };

            const handleExportCSV = () => {
                const header = ['氏名','分類','優先度','バッジ(スキル)','公休','基本_開始','基本_終了','基本_外出','基本_戻り',...DAYS_OF_WEEK.flatMap(d=>[`${DAY_LABELS[d]}_開始`,`${DAY_LABELS[d]}_終了`])];
                const rows = staffList.map(s => [s.name, s.type, s.priority, (s.badges||[]).join('|'), s.daysOff.map(d=>DAY_LABELS[d]).join(''), s.baseShift.start, s.baseShift.end, s.baseShift.breakStart||'', s.baseShift.breakEnd||'', ...DAYS_OF_WEEK.flatMap(d=>{const i=s.irregularShifts[d]; return i?[i.start,i.end]:['',''];})]);
                const csv = [header.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `staff_list.csv`; a.click();
            };
            const handleImportCSV = (e) => {
                const file = e.target.files?.[0]; if (!file) return;
                const r = new FileReader(); r.onload = (ev) => {
                    const lines = ev.target.result.split(/\r\n|\n/).filter(l => l.trim() !== '');
                    const newStaff = [];
                    for(let i=1; i<lines.length; i++) {
                        const c = lines[i].replace(/^"|"$/g,'').split('","');
                        if(c.length < 9) continue;
                        newStaff.push({ id: crypto.randomUUID(), name: c[0], type: c[1]==='部門担当'?'DEPARTMENT':'SPECIALIST', priority: Number(c[2])||50, badges: c[3]?c[3].split('|'):[], daysOff: [], baseShift: {start:c[5],end:c[6],breakStart:c[7],breakEnd:c[8]}, irregularShifts: {} });
                    }
                    if(newStaff.length) { setStaffList([...staffList, ...newStaff]); alert(`${newStaff.length}件追加しました`); }
                    if(fileInputRef.current) fileInputRef.current.value='';
                }; r.readAsText(file);
            };

            if (isEditing && editForm) return (
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-gray-800">スタッフ編集</h3><button onClick={() => setIsEditing(null)} className="text-gray-500 hover:text-gray-700"><XCircle size={24} /></button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium mb-1">氏名</label><input type="text" className="w-full border rounded p-2" value={editForm.name} onChange={e => setEditForm({ ...editForm, name: e.target.value })} /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium mb-1">分類</label><select className="w-full border rounded p-2" value={editForm.type} onChange={e => setEditForm({ ...editForm, type: e.target.value })}><option value="SPECIALIST">レジ専任</option><option value="DEPARTMENT">部門担当</option></select></div>
                                <div><label className="block text-sm font-medium mb-1">優先度</label><input type="range" min="0" max="100" value={editForm.priority} onChange={e => setEditForm({...editForm, priority: Number(e.target.value)})} className="w-full" /></div>
                            </div>
                            <div><label className="block text-sm font-medium mb-1">バッジ(役割)</label><div className="flex flex-wrap gap-2 p-2 border rounded bg-gray-50">{availableBadges.map(b=><button key={b} onClick={()=>toggleBadge(b)} className={`text-xs px-2 py-1 rounded-full border ${editForm.badges.includes(b)?'bg-indigo-600 text-white':'bg-white'}`}>{b}</button>)}</div></div>
                            <div><label className="block text-sm font-medium mb-1">公休</label><div className="flex gap-1">{DAYS_OF_WEEK.map(d=><button key={d} onClick={()=>toggleDayOff(d)} className={`w-8 h-8 rounded-full text-sm ${editForm.daysOff.includes(d)?'bg-gray-800 text-white':'bg-gray-200'}`}>{DAY_LABELS[d]}</button>)}</div></div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-blue-50 p-3 rounded"><span className="text-xs font-bold text-blue-800 block mb-2">基本シフト</span><div className="flex gap-2"><input type="time" className="border p-1" value={editForm.baseShift.start} onChange={e=>setEditForm({...editForm,baseShift:{...editForm.baseShift,start:e.target.value}})} /><span>~</span><input type="time" className="border p-1" value={editForm.baseShift.end} onChange={e=>setEditForm({...editForm,baseShift:{...editForm.baseShift,end:e.target.value}})} /></div></div>
                            <div className="h-64 overflow-y-auto pr-2">{DAYS_OF_WEEK.map(d=>{
                                const irr = editForm.irregularShifts[d];
                                return (<div key={d} className={`p-2 border rounded mb-2 text-sm ${irr?'bg-yellow-50':'bg-gray-50'}`}><div className="flex justify-between font-bold"><span>{DAY_LABELS[d]}</span>{irr?<button onClick={()=>{const n={...editForm.irregularShifts};delete n[d];setEditForm({...editForm,irregularShifts:n})}} className="text-red-500">解除</button>:<button onClick={()=>setEditForm({...editForm,irregularShifts:{...editForm.irregularShifts,[d]:{...editForm.baseShift}}})} className="text-blue-500">個別設定</button>}</div>{irr && <div className="mt-1 flex gap-1"><input type="time" value={irr.start} onChange={e=>setEditForm({...editForm,irregularShifts:{...editForm.irregularShifts,[d]:{...irr,start:e.target.value}}})} className="w-20" />~<input type="time" value={irr.end} onChange={e=>setEditForm({...editForm,irregularShifts:{...editForm.irregularShifts,[d]:{...irr,end:e.target.value}}})} className="w-20" /></div>}</div>);
                            })}</div>
                        </div>
                    </div>
                    <div className="mt-6 flex justify-end gap-3 pt-4 border-t"><button onClick={() => setIsEditing(null)} className="px-4 py-2 bg-gray-100 rounded">キャンセル</button><button onClick={saveEdit} className="px-6 py-2 bg-blue-600 text-white rounded">保存</button></div>
                </div>
            );

            return (
                <div className="bg-white rounded-lg shadow border overflow-hidden">
                    <div className="p-3 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-gray-700">登録スタッフ一覧 ({displayList.length}名)</h3>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} accept=".csv" className="hidden" onChange={handleImportCSV} />
                            <button onClick={()=>fileInputRef.current?.click()} className="flex items-center gap-1 px-3 py-1 bg-white border rounded text-xs whitespace-nowrap hover:bg-gray-50"><Upload size={14}/> CSV読込</button>
                            <button onClick={handleExportCSV} className="flex items-center gap-1 px-3 py-1 bg-white border rounded text-xs whitespace-nowrap hover:bg-gray-50"><FileText size={14}/> CSV出力</button>
                            <button onClick={handleAdd} className="flex items-center gap-1 px-3 py-1 bg-green-600 text-white rounded text-xs whitespace-nowrap hover:bg-green-700"><Plus size={14}/> 新規登録</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm whitespace-nowrap">
                            <thead className="bg-gray-100 text-gray-600 border-b"><tr><th className="p-2">氏名</th><th className="p-2">分類</th><th className="p-2">優先度</th><th className="p-2">バッジ</th><th className="p-2">基本シフト</th><th className="p-2 text-right">操作</th></tr></thead>
                            <tbody className="divide-y">{displayList.map(s=>(<tr key={s.id} className="hover:bg-gray-50"><td className="p-2 font-bold">{s.name}</td><td className="p-2"><span className="bg-gray-100 px-2 py-0.5 rounded text-xs">{s.type}</span></td><td className="p-2"><input type="range" className="w-24 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" value={s.priority} onChange={e=>handlePriorityChange(s.id,Number(e.target.value))} onMouseDown={handleDragStart} onMouseUp={handleDragEnd} /></td><td className="p-2 text-xs text-gray-500">{s.badges?.join(', ')}</td><td className="p-2">{s.baseShift.start}-{s.baseShift.end}</td><td className="p-2 text-right flex justify-end gap-2"><button onClick={()=>startEdit(s)} className="text-blue-600"><Edit2 size={16}/></button><button onClick={()=>deleteStaff(s.id)} className={deleteConfirmId===s.id?"text-white bg-red-600 px-2 rounded":"text-red-600"}><Trash2 size={16}/></button></td></tr>))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const RegisterView = ({ registers, setRegisters }) => {
            const [editingId, setEditingId] = useState(null);
            const [tempName, setTempName] = useState("");
            const addReg = () => setRegisters([...registers, { id: crypto.randomUUID(), name: `${registers.length+1}号`, isActive: true, order: registers.length+1, isBadgeRole: false }]);
            const removeReg = (id) => { if(confirm('削除しますか？')) setRegisters(registers.filter(r=>r.id!==id)); };
            const startEdit = (r) => { setEditingId(r.id); setTempName(r.name); };
            const saveEdit = (id) => { if(tempName.trim()) setRegisters(registers.map(r=>r.id===id?{...r,name:tempName.trim()}:r)); setEditingId(null); };
            const toggleActive = (id) => setRegisters(registers.map(r=>r.id===id?{...r,isActive:!r.isActive}:r));
            const toggleBadge = (id) => setRegisters(registers.map(r=>r.id===id?{...r,isBadgeRole:!r.isBadgeRole}:r));
            const handleDrop = (e, targetIdx) => {
                const srcIdx = Number(e.dataTransfer.getData('text'));
                if(srcIdx===targetIdx) return;
                const list = [...registers].sort((a,b)=>a.order-b.order);
                const [moved] = list.splice(srcIdx, 1);
                list.splice(targetIdx, 0, moved);
                setRegisters(list.map((r,i)=>({...r, order:i+1})));
            };

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center bg-white p-3 rounded shadow-sm border"><h3 className="font-bold">レジ管理</h3><button onClick={addReg} className="flex items-center gap-1 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700"><Plus size={14}/> 追加</button></div>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        {[...registers].sort((a,b)=>a.order-b.order).map((r, i)=>(
                            <div key={r.id} draggable onDragStart={e=>e.dataTransfer.setData('text',i)} onDragOver={e=>e.preventDefault()} onDrop={e=>handleDrop(e,i)} className={`p-3 rounded border-2 transition-all ${r.isActive?'border-blue-500 bg-blue-50 shadow':'border-gray-200 bg-gray-50 opacity-60'}`}>
                                <div className="flex justify-between mb-2"><Monitor size={20} className={r.isActive?'text-blue-600':'text-gray-400'} /><div className="cursor-grab text-gray-400"><GripVertical size={14}/></div></div>
                                <div className="text-center h-8 flex justify-center items-center">{editingId===r.id ? <input autoFocus className="w-full text-center border rounded" value={tempName} onChange={e=>setTempName(e.target.value)} onBlur={()=>saveEdit(r.id)} onKeyDown={e=>{if(e.key==='Enter')saveEdit(r.id)}} /> : <span onClick={()=>startEdit(r)} className="font-bold cursor-pointer">{r.name}</span>}</div>
                                <div className="mt-2 text-center"><button onClick={()=>toggleBadge(r.id)} className={`text-[10px] px-2 py-0.5 rounded border ${r.isBadgeRole?'bg-indigo-600 text-white':'bg-white text-gray-500'}`}>{r.isBadgeRole?'バッジ必須ON':'バッジ必須OFF'}</button></div>
                                <div className="mt-2 flex justify-between items-center"><button onClick={()=>toggleActive(r.id)} className={`text-xs ${r.isActive?'text-blue-600 font-bold':'text-gray-400'}`}>{r.isActive?'稼働中':'停止'}</button><button onClick={()=>removeReg(r.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ShiftView = ({ data, setData }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [printScale, setPrintScale] = useState(1.0);
            const [showOverwriteModal, setShowOverwriteModal] = useState(false);
            
            const currentShift = data.shifts.find(s => s.date === selectedDate);
            const timeSlots = generateTimeSlots(data.settings.openTime, data.settings.closeTime);
            const activeRegs = data.registers.filter(r => r.isActive).sort((a,b)=>a.order-b.order);

            const generate = () => {
                if(currentShift) return setShowOverwriteModal(true);
                execGenerate();
            };
            const execGenerate = () => {
                const newS = generateShift(selectedDate, data.staff, data.registers, data.settings);
                setData({ ...data, shifts: data.shifts.filter(s=>s.date!==selectedDate).concat(newS) });
                setShowOverwriteModal(false);
            };
            const updateCell = (time, regId, staffId) => {
                if(!currentShift) return;
                const newCells = { ...currentShift.cells, [`${time}-${regId}`]: { registerId: regId, staffId: staffId==='__EMPTY__'?null:staffId, isManualOverride: true } };
                setData({ ...data, shifts: data.shifts.map(s=>s.id===currentShift.id?{...s, cells: newCells}:s) });
            };
            
            const getStaffName = (id) => { 
                if(id==='__CLOSED__') return '閉鎖';
                const s = data.staff.find(st=>st.id===id); 
                return s ? s.name : ''; 
            };

            return (
                <div className="space-y-4">
                    {showOverwriteModal && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center"><div className="bg-white p-6 rounded shadow-lg"><p className="mb-4">既にシフトが存在します。上書きしますか？</p><div className="flex justify-end gap-2"><button onClick={()=>setShowOverwriteModal(false)} className="px-4 py-2 bg-gray-200 rounded">キャンセル</button><button onClick={execGenerate} className="px-4 py-2 bg-blue-600 text-white rounded">上書き作成</button></div></div></div>}
                    
                    <div className="bg-white p-4 rounded shadow border no-print">
                        <div className="flex flex-wrap gap-4 items-center justify-between">
                            <div className="flex items-center gap-2"><input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="border p-2 rounded" /><button onClick={generate} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2"><RefreshCw size={16}/> 作成</button></div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold">印刷倍率:</span><input type="range" min="0.5" max="1.0" step="0.05" value={printScale} onChange={e=>setPrintScale(Number(e.target.value))} className="w-24" /><button onClick={()=>window.print()} className="bg-gray-800 text-white px-4 py-2 rounded flex items-center gap-2"><Printer size={16}/> 印刷</button></div>
                        </div>
                    </div>

                    {currentShift ? (
                        <div className="bg-white rounded border overflow-hidden shift-table-container" style={{'--print-scale':printScale}}>
                            <div className="hidden print-only print-header">{selectedDate} ({getDayOfWeek(selectedDate)}) シフト表</div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs text-center border-collapse print-area">
                                    <colgroup><col style={{width:'80px'}}/>{timeSlots.map(t=><col key={t} style={{width:'auto'}}/>)}</colgroup>
                                    <thead><tr><th className="p-2 border bg-blue-50 font-bold sticky left-0 z-10 print:static">号車</th>{timeSlots.map(t=><th key={t} className="p-1 border bg-gray-50">{t}</th>)}</tr></thead>
                                    <tbody className="screen-table-row">
                                        {activeRegs.map(r=>(
                                            <tr key={r.id}>
                                                <td className="p-2 border font-bold sticky left-0 bg-white z-10 text-left pl-2 print:static">{r.name}</td>
                                                {timeSlots.map(t=>{
                                                    const cell = currentShift.cells[`${t}-${r.id}`];
                                                    const name = getStaffName(cell?.staffId);
                                                    return (
                                                        <td key={t} className={`p-0 border relative h-8 ${cell?.isManualOverride?'bg-yellow-50':''} ${cell?.staffId==='__CLOSED__'?'bg-gray-300':''}`}>
                                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none px-1"><span className="truncate">{name.slice(0,5)}</span></div>
                                                            <select className="absolute inset-0 opacity-0 cursor-pointer" value={cell?.staffId||'__EMPTY__'} onChange={e=>updateCell(t,r.id,e.target.value)}>
                                                                <option value="__EMPTY__">空き</option><option value="__CLOSED__">閉鎖</option>
                                                                {data.staff.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                                            </select>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                    {/* Print Optimized Body */}
                                    <tbody className="hidden print-table-row">
                                        {activeRegs.map(r=>{
                                            const merged = [];
                                            let cur = null;
                                            timeSlots.forEach((t, i)=>{
                                                const cell = currentShift.cells[`${t}-${r.id}`];
                                                const sid = cell?.staffId;
                                                if(i===0) cur = {sid, len:1};
                                                else {
                                                    if(sid === cur.sid) cur.len++;
                                                    else { merged.push(cur); cur = {sid, len:1}; }
                                                }
                                            });
                                            merged.push(cur);
                                            return (
                                                <tr key={r.id}>
                                                    <td className="border font-bold text-center">{r.name}</td>
                                                    {merged.map((m,i)=>(<td key={i} colSpan={m.len} className={`border ${m.sid==='__CLOSED__'?'bg-gray-300':''}`}>{getStaffName(m.sid).slice(0,6)}</td>))}
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : <div className="p-10 text-center text-gray-400 no-print">シフトが作成されていません</div>}
                </div>
            );
        };

        // ==========================================
        // Data Management Component (File System Access API)
        // ==========================================
        const DataView = ({ data, setData }) => {
            const [fileHandle, setFileHandle] = useState(null);
            const [fileName, setFileName] = useState("");

            // 1. Open File
            const handleOpenFile = async () => {
                if (!window.showOpenFilePicker) { alert("このブラウザはファイル操作に対応していません。\nChromeまたはEdgeを使用してください。"); return; }
                try {
                    const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON File', accept: { 'application/json': ['.json'] } }] });
                    const file = await handle.getFile();
                    const text = await file.text();
                    const json = JSON.parse(text);
                    if(!json.staff || !json.registers) throw new Error("無効なデータ形式です");
                    
                    setData(json);
                    setFileHandle(handle);
                    setFileName(file.name);
                    alert(`「${file.name}」を読み込みました。`);
                } catch (err) {
                    if(err.name !== 'AbortError') { console.error(err); alert("ファイルの読み込みに失敗しました。"); }
                }
            };

            // 2. Save (Overwrite)
            const handleSave = async () => {
                if (!fileHandle) return handleSaveAs();
                try {
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(data, null, 2));
                    await writable.close();
                    alert(`「${fileName}」に上書き保存しました。`);
                } catch (err) {
                    console.error(err);
                    alert("保存に失敗しました。\n「名前を付けて保存」を試してください。");
                }
            };

            // 3. Save As
            const handleSaveAs = async () => {
                if (!window.showSaveFilePicker) { alert("このブラウザはファイル操作に対応していません。"); return; }
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: `regimaster_backup_${new Date().toISOString().slice(0,10)}.json`,
                        types: [{ description: 'JSON File', accept: { 'application/json': ['.json'] } }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(JSON.stringify(data, null, 2));
                    await writable.close();
                    
                    const file = await handle.getFile();
                    setFileHandle(handle);
                    setFileName(file.name);
                    alert(`「${file.name}」として保存しました。`);
                } catch (err) {
                    if(err.name !== 'AbortError') console.error(err);
                }
            };

            const handleReset = () => {
                if(confirm("データを初期化しますか？\n保存されていないデータは消えます。")) {
                    setData(INITIAL_DATA);
                    setFileHandle(null);
                    setFileName("");
                }
            };

            return (
                <div className="max-w-2xl mx-auto space-y-6">
                    <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg text-sm text-blue-800">
                        <h4 className="font-bold flex items-center gap-2 mb-2"><AlertCircle size={16}/> データ管理について</h4>
                        <p>このアプリはブラウザ内にデータを一時保存していますが、キャッシュクリア等で消える可能性があります。</p>
                        <p className="mt-1 font-bold">重要なデータは必ず「ファイルに保存」してください。</p>
                        {fileName && <div className="mt-3 bg-white p-2 rounded border text-center font-bold text-green-700">現在編集中のファイル: {fileName}</div>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onClick={handleOpenFile} className="bg-white border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 p-6 rounded-xl flex flex-col items-center gap-3 transition-all">
                            <FileJson size={32} className="text-gray-600"/>
                            <span className="font-bold">ファイルを開く</span>
                            <span className="text-xs text-gray-500">保存済みデータを読み込む</span>
                        </button>
                        <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700 text-white p-6 rounded-xl flex flex-col items-center gap-3 shadow-lg transition-all">
                            <Save size={32}/>
                            <span className="font-bold">上書き保存</span>
                            <span className="text-xs text-blue-200">{fileName ? fileName : '新規ファイル作成'}</span>
                        </button>
                        <button onClick={handleSaveAs} className="bg-white border-2 border-gray-200 hover:border-green-500 hover:bg-green-50 p-6 rounded-xl flex flex-col items-center gap-3 transition-all">
                            <Download size={32} className="text-gray-600"/>
                            <span className="font-bold">名前を付けて保存</span>
                            <span className="text-xs text-gray-500">別ファイルとして保存</span>
                        </button>
                    </div>

                    <div className="pt-8 border-t">
                        <button onClick={handleReset} className="text-red-500 text-sm flex items-center gap-2 hover:underline"><Trash2 size={14}/> 全データを初期化する</button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // App Core
        // ==========================================
        const TABS = { SHIFT: 'shift', STAFF: 'staff', REGISTER: 'register', DATA: 'data' };
        const INITIAL_DATA = {
            staff: [],
            registers: Array.from({length:20},(_,i)=>({id:`reg-${i+1}`,name:`${i+1}号`,isActive:i<5,order:i+1,isBadgeRole:false})),
            shifts: [],
            settings: { openTime: DEFAULT_OPEN_TIME, closeTime: DEFAULT_CLOSE_TIME }
        };

        function App() {
            const [activeTab, setActiveTab] = useState(TABS.SHIFT);
            const [data, setData] = useState(INITIAL_DATA);
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (saved) { try { setData(JSON.parse(saved)); } catch (e) { console.error(e); } }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            }, [data, isLoaded]);

            if (!isLoaded) return <div className="flex h-screen items-center justify-center text-gray-500">Loading...</div>;

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
                    <header className="bg-white border-b sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-4 h-14 flex justify-between items-center">
                            <h1 className="text-lg font-bold text-blue-600 flex items-center gap-2"><CalendarRange className="text-blue-600"/> RegiMaster Pro</h1>
                            <nav className="flex gap-1">
                                <TabButton active={activeTab===TABS.SHIFT} onClick={()=>setActiveTab(TABS.SHIFT)} icon={<CalendarRange size={18}/>} label="シフト作成" />
                                <TabButton active={activeTab===TABS.STAFF} onClick={()=>setActiveTab(TABS.STAFF)} icon={<Users size={18}/>} label="スタッフ" />
                                <TabButton active={activeTab===TABS.REGISTER} onClick={()=>setActiveTab(TABS.REGISTER)} icon={<Monitor size={18}/>} label="レジ設定" />
                                <TabButton active={activeTab===TABS.DATA} onClick={()=>setActiveTab(TABS.DATA)} icon={<Database size={18}/>} label="データ" />
                            </nav>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {activeTab === TABS.SHIFT && <ShiftView data={data} setData={setData} />}
                        {activeTab === TABS.STAFF && <StaffView staffList={data.staff} setStaffList={(staff) => setData({ ...data, staff })} availableBadges={data.registers.filter(r=>r.isBadgeRole).map(r=>r.name)} />}
                        {activeTab === TABS.REGISTER && <RegisterView registers={data.registers} setRegisters={(registers) => setData({ ...data, registers })} />}
                        {activeTab === TABS.DATA && <DataView data={data} setData={setData} />}
                    </main>
                </div>
            );
        }

        const TabButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-16 py-1 rounded transition-colors ${active ? 'text-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-100'}`}>
                {icon}
                <span className="text-[9px] font-bold leading-none mt-0.5 whitespace-nowrap">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
